---
title: "Confidence Intervals. Comparison by Monte carlo simulation "
author: 'By: S. Civit'
output:
  html_document:
    code_folding: show
    highlight: haddock
    keep_md: yes
    number_sections: yes
    theme: readable
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
      toc_depth: 3
  pdf_document:
    toc: yes
---


# Statement

**the goal** of this simulation study will be to analize **coverage error and length of confidence interval**", for the mean.

# Simulation study: Pipeline

**Aims**: It is well know that meand sample distribution is:
$$\hat{X} \approx N \left(\mu, \frac{\sigma}{n}\right)$$. 

According to that

$$IC_{(1-\alpha)}(\mu)=\left(\overline{X}- z_{(1-\frac{\alpha}{2})}\frac{\sigma}{\sqrt{n}}, \: \: \overline{X}+ z_{(1-\frac{\alpha}{2})}\frac{\sigma}{\sqrt{n}} \right)$$

We'll perform a simulation study under the following simplifying conditions:

 - **Analyse (pipeline)**: 
    - Estimators: Confidence interval **Lower bound, Upper bound**
 
 - **Generate (pipeline)**:
    - Generating a iid sample size **n** from a ``N(mean, sd)``  
 
- **Sumaryze (pipeline)**: 
    - Properties of Confidence interval: **Coverage**, **length**



# Before to starting 

  - Create a sample dataset with 500 samples of size n=10 from an N(1,2). Add to the data set the estimates of the mean and standard deviation obtained with each of the samples.
  
  - Increase `nsim`


```{r}

# error de recubrimiento= 
# longitud media=

set.seed(54321) # Fijar semilla para reproducibilidad
nsim <- 500
n <- 10

#Valores teóricos:

mu <- 1
sd <- 2

#Muestras 
# nsim *n consigue replicar el numero de valores simulados de la normal de tamaño muestral n
muestras <- as.data.frame(matrix(rnorm(nsim*n, mean=mu, sd=sd), ncol=n))
rownames(muestras) <- paste("muestra", 1:nsim, sep="")
colnames(muestras) <- paste("observaciones", 1:n, sep="")
#muestras

#Estimaciones:
#añadimos al final de las observaciones la media de la muestra y su desviación estandar
muestras$mean <- rowMeans(muestras[,1:n])
muestras$sd <- apply(muestras[,1:n], 1, sd)
#muestras

```

  - Plot sample vs theoretical distribution of the mean 
  
```{r}

# Distribución de la media muestral
hist(muestras$mean,freq = FALSE, breaks = "FD", 
     main = "Media muestral MC versus teórica",xlab = "Medias", ylab = "Densidad")
# Densidad observada (estimación)
lines(density(muestras$mean), col="green") 

# Densidad teórica (bajo normalidad)
curve(dnorm(x, mu, sd/sqrt(n)), lwd = 2, col = "blue", add = TRUE) 

# Aproximación del valor esperado de la media muestral mediante simulación
abline(v = mean(muestras$mean), lty = 2, col="green")  

# Valor esperado de la media muestral (teórico blue color)
abline(v = mu, col = "blue")
legend(1.6,0.6, c("MC mean", "Dist.teórica","MC mean", 
"Valor Pob"), lty = c(1,1,3,3), lwd = c(3,3,4,4), 
col = c("green","blue","green2", "blue2"))


```
- According with  the above results, 

# Performs simulation: `Confidence interval coverage and length for the mean. Normal`

```{r}
# Simulation study 'mean':
alpha <- 0.05
n <- 10
mu <- 5
sigma <- 1
B <- 10000 # numero de simulacions
zalpha <- qnorm(1-(alpha/2)) # calcul del quantil

# INSTRUCCIONS
# generar la mostra
# calcular l'extrem inferior
# calcular l'extrem superior
# mirar si el punt està dins d'aquest interval

lengths <- numeric(B)
coverages <- numeric(B)

for (i in 1:B){
	sample <- rnorm(n, mu, sigma)
	sample_average <- mean(sample)
	latter <- zalpha*sigma/sqrt(n)
	inferior_limit <- sample_average - latter 
	superior_limit <- sample_average + latter

	lengths[i] <- superior_limit - inferior_limit
	coverages[i] <- ((mu < superior_limit) & (mu > inferior_limit))
}

length <- mean(lengths)
coverage <- mean(coverages)
print(paste("Coverage", coverage))
print(paste("lengths: ", length))

```

# Simulation study `Confidence interval coverage and length for the mean. Exponential`:

Ara tocaria fer l'exponencial (DEURES)

La cosa és que $mean = 1/lambda = mu therefore lambda = 1/mu$
```{r}
alpha <- 0.05
n <- 10
mu <- 5           
lambda <- 1/mu
B <- 10000

lengths <- numeric(B)
coverages <- numeric(B)

for (i in 1:B){
	sample <- rexp(n, lambda)
	sample_average <- mean(sample)
	latter <- zalpha*sigma/sqrt(n)
	inferior_limit <- sample_average - latter 
	superior_limit <- sample_average + latter

	lengths[i] <- superior_limit - inferior_limit
	coverages[i] <- ((mu < superior_limit) & (mu > inferior_limit))
}

length <- mean(lengths)
coverage <- mean(coverages)
print(paste("Coverage", coverage))
print(paste("lengths: ", length))

```


# Simulation study 
``Confidence interval coverage and length for the mean. Chi-Square``.
```{r}
alpha<-0.05
n<-10
mu<-5           
sigma<-sqrt(2*mu)     
B=10000

# write your code

#print(list("cobertura"=cobertura,"longitudMC"=longitudMC,"errorcobertura"=errorcobertura,"longitudEXACTA"=longitudEXACTA))
       #error aquí de orden (n^-1/2, TCL) 


```


# Exercises

- **Results (new section) (pipeline)**: 
    - Summarize in a **table** (easy to read) the most relevant results
    
    
 
 - **Conclusions (new section)**:
    - Using bullet points the most important conclusions. 
    


# Exercise 2: Write report acording ADMPR stages

  - Aims
  
  - Data‐generating mechanisms
  
  - Target of analysis
  
  - Performance measures
  
  - Results
  
  - Annex: Coding and Execution
  
# Exercise 3: vaR

VaR is an indicator used in risk management, it represents the maximum potential loss which can occur to a portfolio of a certain investor.

Options to calculate VaR:

  - Parametric VaR (now): $$VaR= W_0 Z_{1-\alpha} \sigma \sqrt(n)$$
The use of the normal distribution of course hides important assumptions which often are fundamental for the reliability of these methods.
  
  - Historical VaR (according to resampling methods: Bootstrap methodology): 
    $$VaR= W_0 quantile(1-\alpha, H) \sigma \sqrt(n)$$

# VaR (Value at risk)



